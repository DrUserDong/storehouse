---
layout: post
title: OTA在企业分发中的应用
description: 建立适用于海底捞现有架构的OTA分发机制
data: 2017-04-21 14:01:53 +0800
categories: iOS
image: assets/images/OTA/OTA-cover.jpeg
---

针对海底捞系统架构，利用 OTA(Over the Air) 进行 iOS 应用分发。达到应用快速分发、环境快速搭建、版本精确控制、轻松维护的分发目的。

## OTA介绍

OTA（Over the Air），是Apple在 iOS4 中新加的一项技术，目的是让开发者能够脱离Appstore，实现从自己的服务器下载并安装iOS应用。简单地说，就是用户只需要在Safari中点开一条链接，就能直接在主界面中安装App。OTA方式安装，是通过Safari解析链接中的 `itms-services://` 来实现的。

OTA的原理如下图所示：

![OTA原理]({{ site.url }}/assets/images/OTA/ota_yuanli.jpg)

**注意**：OTA仅适用于 Ad-Hoc 和 In-House类型的 APP，或者在越狱设备上安装

不了解 iOS APP 分发？[About App Distribution Workflows](https://developer.apple.com/library/content/documentation/IDEs/Conceptual/AppDistributionGuide/Introduction/Introduction.html)

## 现有架构

海底捞的每一家门店的点餐系统都是一个与其他门店相对独立的系统，在总部将一些配置信息下发到门店后，门店内通过局域网即可完成整个点餐业务，包括点菜、下单、传菜、厨打、上菜、支付、结账、报表等等一系列点餐业务。

而 iPad 点餐早已成为海底捞火锅的一大特色。 iOS 流畅的用户体验和相比安卓设备更高的续航给顾客带来了更好用餐体验，成为海底捞产品竞争力的一大体现。

`iPad点餐APP` 为 [`企业级` 用户](https://developer.apple.com/support/compare-memberships/)所打包的APP，不能上架 `App Stroe`，是苹果为企业级应用推出，仅供企业内部使用的开发者服务。APP可以直接安装在 iOS 设备上使用。

然而面对全国数百家门店，版本控制就变得尤为重要。如何针对每家门店去发布不同版本的点餐APP，如何利用更少的劳动力去安装APP，如果在有限的人员维护下用更短的时间进行产品推广等等问题都变的尤为重要。

所以一个适用于海底捞的应用分发系统需要具有以下特点：

- 精确的版本控制：针对不同门店可以分发不同版本的APP
- 更快速的安装：系统需要具备在短时间内可以迅速将应用安装到店内几百台 iOS 设备上
- 更简便的安装操作：运维人员执行更少的操作
- 问题更容易被排查：对于突发情况无法分发APP时，系统可以快速精确的定位问题并解决问题

## 海底捞iOS APP分发的历史解决方案

海底捞的 iOS APP 分发经历了如下阶段：

### 1. 手动安装

企业级分发的APP可以将设备连接到电脑上，通过 iTunes 来进行手动安装，但是该方法效率低下，所以该方式在我入职之前就已经被 pass 了

### 2. MDM推送

该方案是使用的第三方公司提供的 `MDM服务`。
其实提供的 `MDM服务` 利用的还是苹果提供的 `MDM服务`，每台 iOS 设备需要通过苹果官方Mac APP：[App Configurator 2](https://itunes.apple.com/cn/app/apple-configurator-2/id1037126344?mt=12) 统一刷 `监管模式`，这样 iOS 设备就处于受监管模式了。使用苹果的 `MDM` 服务，能够实现 APP 的静默安装。

但是海底捞的MDM供应商是将安装包放在MDM服务器（总部的一台服务器）上，很多设备同时请求更新的话，就会变的很慢，速度不仅受总部并发量、总部带宽限制，还受门店的外网带宽限制。

MDM分发的模式为：
	1. 在每台被监管的 iOS 设备上安装 MDM 分发应用。
	2. 在分发应用内登录相应账号对设备进行登记。
	3. iOS APP 发版时再 MDM 后台上传 `ipa` 安装包。
	4. 选择要推送的应用和设备组进行MDM推送。
	5. APP会被静默安装到设备中。

**缺点**：虽然运维操作简便，但是速度极慢，如果需要全国推广某个版本，可能会经历好几个月😱。而且会出现推送不成功的情况，解决问题只能通过MDM供应商来解决（跨公司处理问题，呵呵）。此外值得一提的是，除去第一年的部署费用，以后每年MDM供应商收费是按照设备数量来的😂，海底捞发展到现在全球都有门店的规模，算下来每年也是一笔不小的费用。


### 3. OTA 局域网推送

OTA局域网推送是将 ipa 部署在店内的点餐系统服务器上，利用局域网内的访问 `itms-services://` 链接中指向在门店服务器上的 ipa 安装包来实现快速分发应用。

该方案有效的利用了海底捞门店点餐系统相互独立的特点，充分利用局域网的速度，实现iOS APP的快速分发。

**注意**：OTA的前提是 HTTPS 环境，由于是局域网环境，所以搭建HTTPS环境使用的是自签名（自己当CA给自己的网站签证书）。
不懂 HTTPS 可以百度百科😂:[HTTPS](http://baike.baidu.com/item/https)

由于我已经为运维们写好了环境搭建和发布新版本所用的脚本，所以环境搭建简单和版本发布变的非常简单，排查问题时非常容易排查。具体的环境搭建可以参考

- [以无线方式安装企业内部应用](http://help.apple.com/deployment/ios/#/apda0e3426d7)
- [一步一步实现无线安装iOS应用(内网OTA)](http://www.jianshu.com/p/35ca63ec0d8e)

**缺点**：
1. 该方案无法实现静默安装，需要手动安装升级（该动作一般由服务员完成）
2. 无法对全国门店的版本进行统计 
3. 在 `2017/3/20` 左右，我们发现该方案无法安装 `iOS 10.3` 以上版本（不得不叫苹果一声爸爸😂）

局域网OTA的架构设计如下图所示：

![局域网OTA泳道图]({{ site.url }}/assets/images/OTA/OTA-自签名.png)

### 4. OTA 分发平台

现在苹果爸爸在 iOS 10.3 以上不让自签名下的OTA分发了（我给苹果技术支持打电话他们也说不出个所以然，可是事实就是不行了😂）

事实是：iOS 10.3 以上无法通过 自签名的 `itms-services://` url来OTA安装，却可以通过权威CA签发证书的域名来安装成功（😭别问我是怎么知道的，我能怎么办，我也很绝望啊）

所以又设计出了如下方案，不过相比 局域网OTA，还是有优点的。

在总部搭建一个 `OTA分发平台`，该平台的HTTPS是用过权威CA签发的（我司用的是阿里的免费赛门铁克CA签发的HTTPS域名，如果是我自己用，当然也会选阿里呀[😊微笑中透露着贫穷]）

需要**注意**的是：该分发平台与蒲公英、fir.im还不太一样，他们的ipa安装包是直接放在他们的服务器上的，而海底捞应用分发平台的服务器中只维护各个门店的应用清单文件，清单文件内的安装包路径指向的是门店服务器上ipa安装包的局域网地址。

这样有效的节省了带宽，使得真正的下载安装动作还是发生在店内局域网，能够保持和 `局域网OTA` 方案一样的下载速度。同时还能在总部对所有门店的版本进行监控。

**缺点**：该方案无法实现静默安装，需要手动安装升级（该动作一般由服务员完成）

改方案的架构如下：

![OTA分发平台泳道图]({{ site.url }}/assets/images/OTA/OTA-分发平台.png)

## 写在最后

上面的每一种方案都没能完美解决海底捞应用分发所需要面对的问题，但是综合对比的话，方案4 `OTA分发平台` 还是可以满足现有的基本需求的。

其实完美的解决方案是搭建适用于局域网的 MDM 推送服务，可惜我至今还没有腾出精力去研究MDM的开发😂（隐约感觉这个会很难，要不怎么会有专门的公司拿这个来卖钱呢😱，我好像找到了一条发家致富的道路😏）

如果有接触过这类知识或者有兴趣的同胞可以联系一下，我好向你学习讨教一下啦，还是很期待来亲自做一下MDM的😎

<a href="mailto:liuzexiang@live.cn" class="button">Mail to Me</a>

